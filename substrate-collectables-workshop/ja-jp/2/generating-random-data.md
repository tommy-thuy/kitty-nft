ランダムなデータを生成する
===

前回のセクションの終盤で、各ユーザーに自分のキティを作ることを許可しました。しかし、キティはまだユニークではありません。今回はユニークさを実装します。

## ランダムシードを生成する
キティを区別することができるようにしたい場合は、それらに固有の特性を付与する必要があります。我々のアプリでは、それぞれのキティといくつかのランダムな `dna`に対してユニークな`id`を生成する必要があります。

チェーンでランダム性を安全に取得するには、SRMLの`system`モジュールを使いましょう。Rustによって提供されている`rand`モジュールなどは脆弱性があり、ブロックチェーンのランタイムには不適切です。

```rust
<system::Module<T>>::random_seed()
```

Substrateは、前のブロックのエントロピーを使用して、後続の各ブロックの新しいランダムデータを生成する安全なミキシングアルゴリズムを使用します。

ただし、前のブロックに依存しているため、完全な効果を発揮するのに80ブロック以上必要であり、それまではシードが変化しないかもしれません。

### ナンス(Nonce)を使う

ランダムシードは同じブロック内の複数のトランザクションに対して変化せず、さらには最初の80ブロックに対してはランダムシードを生成さえしないかもしれません。なので、モジュールが管理可能な`nonce`を導入することは非常に重要です。さらに、`AccountId`のようなユーザー固有のプロパティを追加のエントロピーとして導入することで、より安全なランダム性を再現することができます。

これらのデータのコンビネーションをハッシュ化することができれば、今回のニーズに十分なランダム性を手に入れられます。

## データのハッシュ化

Substrateでは以下のようにランダムな数字を作成できます：

```rust
let sender = ensure_signed(origin)?;
let nonce = <Nonce<T>>::get();
let random_seed = <system::Module<T>>::random_seed();

let random_hash = (random_seed, sender, nonce).using_encoded(<T as system::Trait>::Hashing::hash);

<Nonce<T>>::mutate(|n| *n += 1);
```

`Nonce`はストレージ内の新しいアイテムになり、使用するたびに`1`ずつ増加させています。

この`random_hash`をキティの`id`と`dna`として使用します。

## 衝突検証

複数のキティを追跡するには、ユニークなIDをグローバルキーとして使用するようにロジックを標準化すると便利です。`Kitty`オブジェクトの`id`はその目的を果たしますが、新しくストレージに追加されるキティの`id`が既存のキティの`id`と被りが無いことを保証しなくてはなりません。

衝突検証には`id`（`Hash`）から`Kitty`オブジェクトへのマッピングとなる、新しいストレージ項目の`Kitties`を使います。

これにより、特定の`id`を使ったマッピングが`Kitties`内に既に含まれているかどうかを確認することができます：

```rust
ensure!(!<Kitties<T>>::exists(new_id), "This new id already exists");
```

ランダムに生成された2つのハッシュが衝突する可能性は低いですが、キティを生成するための他の方法を導入する可能性があるため、このチェックを行うことが重要です。

## 演習してみよう!

ユニークな特性をキティに持たせるために、ランダムデータを生成してユニークな`id`を作りましょう。

`id`を`Kitty`オブジェクトにマッピングする新しい`Kitties`ストレージアイテムを紹介します。また、キティを所有する`AccountId`に`id`をマッピングする`KittyOwner`ストレージアイテムも作成したいと思います。

最後に、`Kitty`オブジェクトのコピーを持つのではなく、このユニークな`id`を指すように`OwnedKitty`オブジェクトを更新します。

新しいストレージアイテムをすべて設定したので、次は、キティが作られたときにこれらのストレージアイテムを正しく更新するために`create_kitty()`関数も更新する必要があります。

セクションのテンプレートの指示に従って作業を進めてください。

<!-- tabs:start -->

#### ** テンプレート **

[embedded-code](../../2/assets/2.1-template.rs ':include :type=code embed-template')

#### ** 解答 **

[embedded-code-final](../../2/assets/2.1-finished-code.rs ':include :type=code embed-final')

<!-- tabs:end -->
